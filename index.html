<!DOCTYPE html>
<html>
  <head>
    <title>Vue.jsの基本</title>
    <meta charset="UTF-8" />
  </head>
  <body>
    <h1>ToDoリスト</h1>
    <div id="app">
      <form @submit.prevent="addToDo">
        <input v-model="newToDo" placeholder="ToDoを入力" />
        <button>登録</button>
      </form>
      <ul>
        <li v-for="toDo in showToDoList" :key="toDo.id">
          <div v-if="toDo.edit">
            <form
              style="display: inline"
              @submit.prevent="finishEditToDo(toDo.id)"
            >
              <input v-model="editToDo" />
              <button>登録</button>
            </form>
          </div>
          <div v-else>
            {{ toDo.text }}
            <form
              style="display: inline"
              @submit.prevent="startEditToDo(toDo.id)"
            >
              <button>編集</button>
            </form>
            <form style="display: inline" @submit.prevent="removeToDo(toDo.id)">
              <button>削除</button>
            </form>
          </div>
        </li>
      </ul>
    </div>

    <script type="module">
      import {
        createApp,
        reactive,
        ref,
        onMounted,
      } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

      createApp({
        setup() {
          const showToDoList = ref("");
          const newToDo = ref("");
          const editToDo = ref("");
          onMounted(() => {
            showToDoList.value = getToDoList();
          });
          const getToDoList = () => {
            return JSON.parse(localStorage.getItem("toDoList") ?? "[]");
          };
          const setToDoList = (toDoList) => {
            showToDoList.value = toDoList;
            localStorage.setItem("toDoList", JSON.stringify(toDoList));
          };
          const getMaxId = () => {
            const toDoList = getToDoList();
            if (toDoList.length === 0) {
              return 0;
            } else {
              return Math.max(...toDoList.map((toDo) => toDo.id));
            }
          };
          const getToDoById = (toDoList, id) => {
            for (const toDo of toDoList) {
              if (toDo.id === id) {
                return toDo;
              }
            }
          };
          const addToDo = () => {
            const toDoList = getToDoList();
            toDoList.push({
              id: getMaxId() + 1,
              text: newToDo.value,
              edit: false,
            });
            newToDo.value = "";
            setToDoList(toDoList);
          };
          const startEditToDo = (id) => {
            const toDoList = getToDoList();
            const toDo = getToDoById(toDoList, id);
            toDo.edit = true;
            editToDo.value = toDo.text;
            setToDoList(toDoList);
          };
          const finishEditToDo = (id) => {
            const toDoList = getToDoList();
            const toDo = getToDoById(toDoList, id);
            toDo.edit = false;
            toDo.text = editToDo.value;
            setToDoList(toDoList);
          };
          const removeToDo = (id) => {
            let toDoList = getToDoList();
            toDoList = toDoList.filter((t) => t.id !== id);
            setToDoList(toDoList);
          };

          return {
            showToDoList,
            newToDo,
            editToDo,
            getToDoList,
            addToDo,
            startEditToDo,
            finishEditToDo,
            removeToDo,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
